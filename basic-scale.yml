version: "2"
services:
  kamailio:
    build: ./kamailio
    #image: wtelecom/kamailio:uc-1
    restart: always
    depends_on:
      - db
      - rtpproxy
    environment:
      - constraint:node==D-RSC-SWT-DOC01
      - SWARM_MASTER_IP=10.128.19.60
      - SWARM_MASTER_PORT=3375
      - SUBNET_OVERLAY=192.168.2.0
      - SUFFIX_OVERLAY=int
      - SUFFIX_GWBRIDGE=ext
    ports:
      - "5060:5060/udp"
      - "5061:5061/udp"
    hostname: kamailio
    container_name: kamailio
    networks:
      - uc-ol

  rtpproxy:
    build: ./rtpproxy
    #image: wtelecom/rtpproxy:uc-1
    restart: always
    depends_on:
      - db
    environment:
      - SWARM_MASTER_IP=10.128.19.60
      - SWARM_MASTER_PORT=3375
      - PORT_MAX=10005
     # - PORT_MAX=10099
      - PORT_MIN=10000
      - SUBNET_OVERLAY=192.168.2.0
      - SUFFIX_OVERLAY=int
      - SUFFIX_GWBRIDGE=ext
      - PORT_RTPPROXY=7711
      - DB_KAMAILIO=kamailio_db
      - TABLE_RTPPROXY=rtpproxy
      - DB_USER=kamailio_user
      - DB_PWD=kamailiorw
      - DB_HOST=db
      - SSH_KAMAILIO_PASSWORD=docker
      - SSH_KAMAILIO_USER=root
      - KAMAILIO_HOST=kamailio

    ports:
     # - "10000-10399:10000-10399/udp"
     # - "10000-10099/udp"
      - "10000:10000/udp"
      - "10001:10001/udp"
      - "10002:10002/udp"
      - "10003:10003/udp"
      - "10004:10004/udp"
      - "10005:10005/udp"
    expose:
      - "7711"
    dns:
      - 10.128.2.2
      - 10.128.2.3
    dns_search: wtelecom.es
    networks:
      - uc-ol

  db:
    build: ./mysql
    #image: wtelecom/mysql:uc-1
    restart: always
    environment:
      - constraint:node==D-RSC-SWT-DOC01
      - MYSQL_ROOT_PASSWORD=supersecret
    volumes:
      - ./mysql/dataDir:/var/lib/mysql
    hostname: db
    container_name: db
    networks:
      - uc-ol

networks:
  uc-ol:
    driver: overlay
    ipam:
      driver: default
      config:
        - subnet: 192.168.2.0/24
          ip_range: 192.168.2.0/24
          gateway: 192.168.2.1
